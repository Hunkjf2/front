<div class="flex flex-col w-full">
    <span class="mb-2" *ngIf="label">{{ label }}:</span>
    <mat-form-field class="w-full" appearance="outline">
        <mat-label>{{ placeholder }}</mat-label>

        <mat-chip-grid #chipGrid [attr.aria-label]="ariaLabel">
            @for (client of selectedClients; track client.id) {
            <mat-chip-row 
                (removed)="removeClient(client)" 
                [editable]="false"
                [disabled]="disabled">
                {{ client.name }}
                <button 
                    matChipRemove 
                    [attr.aria-label]="'remove ' + client.name"
                    [disabled]="disabled">
                    <mat-icon>cancel</mat-icon>
                </button>
            </mat-chip-row>
            }
        </mat-chip-grid>

        <input 
            [placeholder]="inputPlaceholder"
            #clientInput 
            [formControl]="clientCtrl" 
            [matAutocomplete]="auto"
            [matChipInputFor]="chipGrid" 
            matInput 
            (focus)="onInputFocus()"
            [disabled]="disabled"
            autocomplete="off">

        <mat-error *ngIf="hasError && errorMessage">
            {{ errorMessage }}
        </mat-error>
    </mat-form-field>

    <mat-autocomplete 
        #auto="matAutocomplete"
        (optionSelected)="selectClient($event.option.value); clientInput.value = ''"
        [displayWith]="null">

        @for (client of filteredClients | async; track client.id) {
        <mat-option 
            [value]="client"
            [class.selected-option]="isClientSelected(client)">
            <div class="flex items-center justify-between w-full py-1">
                <div class="flex flex-col">
                    <span class="font-medium">{{ client.name }}</span>
                    <span class="text-sm text-gray-500" *ngIf="client.email">
                        {{ client.email }}
                    </span>
                </div>
                <mat-icon *ngIf="isClientSelected(client)" class="text-primary-500">
                    check
                </mat-icon>
            </div>
        </mat-option>
        }

        @if ((filteredClients | async)?.length === 0) {
        <mat-option disabled class="text-center text-gray-500">
            {{ emptyMessage }}
        </mat-option>
        }
    </mat-autocomplete>
</div>